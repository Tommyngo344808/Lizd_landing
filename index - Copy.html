<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIZD ‚Äì NaMat</title>
  <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon" />
  <link href="https://unpkg.com/@picocss/pico@2/css/pico.min.css" rel="stylesheet">

  <style>
    :root {
      --brand: #0ea5e9;
      --brand-2: #0284c7;
    }
    body { background:#fff }
    header {
      background: linear-gradient(135deg, #d946ef, #f97316, #f59e0b);
      color:#fff;
      min-height: 52vh;
      display:flex;
      align-items:center;
      position:relative;
      overflow:hidden;
    }
    header .wrap { width:min(1100px, 94%); margin-inline:auto; padding-block:3rem; text-align:center }
    header .badge { display:inline-flex; align-items:center; gap:.5rem; background:#fff3; padding:.35rem .7rem; border-radius:999px; font-size:.9rem }
    header h1 { font-weight:800; line-height:1.12; font-size: clamp(2rem, 4.5vw, 3rem); margin:.6rem 0 1rem }
    header p.sub { opacity:.95; margin-bottom:1rem }
    header .cta { background: var(--brand); border:none; color:#fff; padding:.65rem 1rem; border-radius:.6rem; }
    header .cta:hover { background:var(--brand-2) }

    .hero-image {
      position:absolute; inset:0; opacity:.18; background-size:cover; background-position:center;
      filter: saturate(1.05) contrast(1.02); z-index:0;
      transition: background-image .2s ease;
    }
    header .wrap>* { position:relative; z-index:1 }

    .section {
      width:min(1100px, 94%); margin-inline:auto; padding-block:3rem;
    }
    .grid-4 {
      display:grid;
      grid-template-columns: repeat(4,minmax(0,1fr));
      gap:16px;
    }
    @media (max-width: 1024px) { .grid-4 {grid-template-columns: repeat(3,minmax(0,1fr));} }
    @media (max-width: 760px)  { .grid-4 {grid-template-columns: repeat(2,minmax(0,1fr));} }
    @media (max-width: 520px)  { .grid-4 {grid-template-columns: 1fr;} }

    .card {
      border:1px solid #eee; border-radius:12px; overflow:hidden; background:#fff;
      display:flex; flex-direction:column; position:relative;
    }
    .card .cover {
      aspect-ratio: 4/3; background:#f6f7f8 center/cover no-repeat;
      border-bottom:1px solid #f0f0f0;
    }
    .card .body { padding:14px; display:flex; flex-direction:column; gap:8px }
    .price { color:#ef4444; font-weight:700 }
    .list-price { color:#94a3b8; text-decoration:line-through; font-size:.95rem }
    .btn { background:var(--brand); border:none; color:#fff; padding:.5rem .8rem; border-radius:8px; font-size:.9rem }
    .btn:hover { background:var(--brand-2) }
    .btn.secondary { background:#e2e8f0; color:#0f172a }
    .btn.danger { background:#ef4444; color:#fff }

    /* N√∫t Admin n·ªïi */
    .fab-admin { position:fixed; right:16px; bottom:16px; z-index:50 }
    .modal { max-width:960px }
    .helper { color:#64748b; font-size:.9rem }
    .muted { color:#94a3b8 }
    .input-row { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px }
    @media (max-width: 760px){ .input-row { grid-template-columns: 1fr } }
    .chips { display:flex; gap:8px; flex-wrap:wrap }
    .chip { background:#f1f5f9; border:1px dashed #e2e8f0; padding:.25rem .5rem; border-radius:999px; font-size:.8rem }

    /* N√∫t xo√° tr√™n t·ª´ng card khi b·∫≠t ch·∫ø ƒë·ªô xo√° */
    .delete-badge {
      display:none; position:absolute; top:8px; right:8px; padding:.25rem .5rem; border-radius:8px;
      background:#ef4444; color:#fff; font-size:.75rem; cursor:pointer;
    }
    .delete-enabled .delete-badge { display:inline-block; }
  </style>
</head>
<body>

<!-- HERO -->
<header>
  <div id="heroImage" class="hero-image"></div>
  <div class="wrap">
    <span class="badge">üî• FLASH SALE</span>
    <h1 id="heroTitle">N·ªî ƒê·ªòI GI√Å</h1>
    <p id="heroSub" class="sub">ChƒÉn Ga G·ªëi Cao C·∫•p ‚Äì Gi·∫£m ƒê·∫øn 50%</p>
    <button class="cta" onclick="document.getElementById('products').scrollIntoView({behavior:'smooth'})">
      üõí Xem s·∫£n ph·∫©m
    </button>
  </div>
</header>

<!-- PRODUCTS -->
<section id="products" class="section">
  <h3>üß° S·∫£n ph·∫©m n·ªïi b·∫≠t</h3>
  <p id="loadNote" class="helper">ƒêang hi·ªÉn th·ªã d·ªØ li·ªáu g·∫ßn nh·∫•t‚Ä¶</p>
  <div id="productGrid" class="grid-4"></div>
</section>

<!-- FOOTER -->
<footer class="section">
  <div class="grid">
    <div>
      <h4>Li√™n h·ªá</h4>
      <p class="muted">
        üìû 0949 090 033 ¬∑ Zalo: 0949 090 033 <br>
        Facebook: NaMat.lizd
      </p>
      <small class="muted">¬© 2025 LIZD ‚Äì NaMat</small>
    </div>
  </div>
</footer>

<!-- Admin floating button -->
<button class="btn fab-admin" data-target="adminModal">‚öôÔ∏è Admin</button>

<!-- ADMIN MODAL -->
<dialog id="adminModal" class="modal">
  <article>
    <header>
      <h3>Admin Panel</h3>
      <a href="#" aria-label="Close" class="close" data-close></a>
    </header>

    <!-- Token -->
    <label>Admin token
      <input id="adminToken" placeholder="lizard-9999" />
    </label>

    <hr>

    <!-- HERO -->
    <h4>Hero</h4>
    <div class="input-row">
      <input id="heroTitleInput" placeholder="Ti√™u ƒë·ªÅ l·ªõn" />
      <input id="heroSubInput" placeholder="M√¥ t·∫£ ng·∫Øn" />
      <!-- Cho ph√©p nh·∫≠p URL th·ªß c√¥ng -->
      <input id="heroUrlInput" placeholder="URL ·∫£nh b√¨a (ƒë·ªÉ tr·ªëng = d√πng gradient)" />
    </div>
    <div class="input-row">
      <!-- Upload ·∫£nh b√¨a t·ª´ m√°y -->
      <input type="file" id="heroFile" accept="image/*">
      <button class="btn" id="btnHeroUpload">Upload ·∫£nh b√¨a</button>
      <div class="chips">
        <button class="btn" id="btnHeroApply">√Åp d·ª•ng ra trang</button>
        <button class="btn secondary" id="btnHeroSaveLocal">L∆∞u t·∫°i tr√¨nh duy·ªát</button>
      </div>
    </div>
    <small class="helper">·∫¢nh hero khuy·∫øn ngh·ªã: <b>1920 √ó 600</b> (c·∫Øt trung t√¢m). T·ªëi thi·ªÉu 1600 √ó 500.</small>

    <hr>

    <!-- ADD PRODUCT -->
    <h4>Th√™m s·∫£n ph·∫©m m·ªõi</h4>
    <div class="input-row">
      <input id="pName" placeholder="T√™n s·∫£n ph·∫©m" />
      <input id="pListPrice" type="number" placeholder="Gi√° ni√™m y·∫øt" />
      <input id="pPrice" type="number" placeholder="Gi√° sau CK" />
    </div>
    <label>M√¥ t·∫£
      <textarea id="pDesc" rows="3" placeholder="M√¥ t·∫£ ng·∫Øn‚Ä¶"></textarea>
    </label>
    <div class="input-row">
      <input type="file" id="pImages" multiple accept="image/*">
      <button class="btn" id="btnUploadProdImgs">Upload ·∫£nh SP</button>
      <button class="btn secondary" id="btnClearUploaded">Xo√° ·∫£nh ƒë√£ ch·ªçn</button>
    </div>
    <div id="uploadedChips" class="chips"></div>

    <details>
      <summary>üßπ Qu·∫£n l√Ω s·∫£n ph·∫©m m·∫´u / d·ªçn d·∫πp</summary>
      <div class="grid">
        <button class="btn danger" id="btnRemoveSamples">Xo√° s·∫£n ph·∫©m m·∫´u tr√™n trang</button>
        <button class="btn secondary" id="btnToggleDeleteMode">B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô xo√° t·ª´ng s·∫£n ph·∫©m</button>
        <small class="helper">H·ªá th·ªëng s·∫Ω c·ªë g·∫Øng nh·∫≠n di·ªán th·∫ª s·∫£n ph·∫©m m·∫´u theo <code>.sample</code>, <code>.is-sample</code> ho·∫∑c <code>[data-sample="1"]</code>. B·∫°n c≈©ng c√≥ th·ªÉ b·∫≠t ch·∫ø ƒë·ªô xo√° ƒë·ªÉ b·∫•m xo√° t·ª´ng th·∫ª ƒëang hi·ªÉn th·ªã.</small>
      </div>
    </details>

    <footer class="grid">
      <button class="btn secondary" data-close>ƒê√≥ng</button>
      <button class="btn" id="btnCreateProduct">T·∫°o s·∫£n ph·∫©m</button>
    </footer>
  </article>
</dialog>

<script>
  // ===== Helper: Local storage =====
  const store = {
    get(k, fallback=null){ try { return JSON.parse(localStorage.getItem(k)) ?? fallback } catch { return fallback } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  // ===== Modal open/close =====
  document.querySelectorAll('[data-target]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.getElementById(btn.dataset.target).showModal();
    });
  });
  document.querySelectorAll('[data-close]').forEach(btn=>{
    btn.addEventListener('click', (e)=> {
      e.preventDefault();
      btn.closest('dialog').close();
    });
  });

  // ===== HERO logic (fix: cho ph√©p nh·∫≠p/preview ·∫£nh b√¨a) =====
  const heroImageEl = document.getElementById('heroImage');
  const heroTitleEl = document.getElementById('heroTitle');
  const heroSubEl   = document.getElementById('heroSub');

  const heroTitleInput = document.getElementById('heroTitleInput');
  const heroSubInput   = document.getElementById('heroSubInput');
  const heroUrlInput   = document.getElementById('heroUrlInput');
  const heroFileInput  = document.getElementById('heroFile');

  function applyHero({title, sub, url}){
    if(title) heroTitleEl.textContent = title;
    if(sub) heroSubEl.textContent = sub;
    if(url && url.trim() !== '') {
      heroImageEl.style.backgroundImage = `url('${url}')`;
      heroImageEl.style.opacity = 1;
    } else {
      heroImageEl.style.backgroundImage = '';
      heroImageEl.style.opacity = .18;
    }
  }

  // Load saved hero on start
  const savedHero = store.get('heroSettings');
  if(savedHero){ applyHero(savedHero); }

  // Instant preview when a file is chosen
  heroFileInput?.addEventListener('change', (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const url = URL.createObjectURL(file);
    heroImageEl.style.backgroundImage = `url('${url}')`;
    heroImageEl.style.opacity = 1;
  });

  // Upload button -> convert to dataURL & put into input (no backend required)
  document.getElementById('btnHeroUpload')?.addEventListener('click', async ()=>{
    const file = heroFileInput.files?.[0];
    if(!file){ alert('Ch∆∞a ch·ªçn file ·∫£nh b√¨a'); return; }
    const dataUrl = await fileToDataURL(file);
    heroUrlInput.value = dataUrl;
    applyHero({url: dataUrl});
    alert('·∫¢nh b√¨a ƒë√£ s·∫µn s√†ng (ƒë√£ nh√∫ng d·∫°ng Data URL).');
  });

  document.getElementById('btnHeroApply')?.addEventListener('click', ()=>{
    applyHero({
      title: heroTitleInput.value,
      sub: heroSubInput.value,
      url: heroUrlInput.value
    });
  });

  document.getElementById('btnHeroSaveLocal')?.addEventListener('click', async ()=>{
    const cfg = {
      title: heroTitleInput.value || heroTitleEl.textContent,
      sub:   heroSubInput.value   || heroSubEl.textContent,
      url:   heroUrlInput.value   || (heroImageEl.style.backgroundImage?.slice(5, -2) || '')
    };
    try {
      if (cfg.url && cfg.url.startsWith('data:') && cfg.url.length > 500000) {
        // compress big data URLs before saving
        cfg.url = await compressDataURL(cfg.url);
      }
      const payload = JSON.stringify(cfg);
      if (payload.length > 4800000) {
        alert('·∫¢nh b√¨a qu√° l·ªõn ƒë·ªÉ l∆∞u trong tr√¨nh duy·ªát. H√£y d√πng n√∫t Upload ƒë·ªÉ l·∫•y URL ·∫£nh, r·ªìi L∆∞u l·∫°i.');
        return;
      }
      localStorage.setItem('heroSettings', payload);
      alert('ƒê√£ l∆∞u c·∫•u h√¨nh hero v√†o tr√¨nh duy·ªát.');
    } catch(err){
      console.error(err);
      alert('Kh√¥ng th·ªÉ l∆∞u v√¨ v∆∞·ª£t gi·ªõi h·∫°n b·ªô nh·ªõ c·ªßa tr√¨nh duy·ªát. H√£y d√πng ‚ÄúUpload ·∫£nh b√¨a‚Äù ƒë·ªÉ c√≥ URL ng·∫Øn r·ªìi l∆∞u l·∫°i.');
    }
  });


  // === Added: image compression to avoid localStorage quota ===
  async function compressDataURL(dataUrl, maxW=1600, maxH=600, quality=0.82){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=>{
        let {width:w, height:h} = img;
        const ratio = Math.min(maxW / w, maxH / h, 1);
        const cw = Math.round(w * ratio);
        const ch = Math.round(h * ratio);
        const canvas = document.createElement('canvas');
        canvas.width = cw; canvas.height = ch;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, cw, ch);
        // export jpeg to reduce size
        const out = canvas.toDataURL('image/jpeg', quality);
        resolve(out);
      };
      img.onerror = reject;
      img.src = dataUrl;
    });
  }

  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ===== PRODUCTS (ch·ªâ th√™m c√¥ng c·ª• d·ªçn d·∫πp/xo√°) =====
  const grid = document.getElementById('productGrid');

  // (T√πy ch·ªçn) Kh√¥i ph·ª•c tr·∫°ng th√°i "·∫©n s·∫£n ph·∫©m m·∫´u"
  if (store.get('hideSampleProducts')) {
    removeSampleCards();
  }

  // Toggle ch·∫ø ƒë·ªô xo√° t·ª´ng th·∫ª
  let deleteMode = false;
  document.getElementById('btnToggleDeleteMode')?.addEventListener('click', ()=>{
    deleteMode = !deleteMode;
    grid.classList.toggle('delete-enabled', deleteMode);
    if(deleteMode){
      ensureDeleteBadges();
    } else {
      document.querySelectorAll('.delete-badge').forEach(el => el.remove());
    }
  });

  // N√∫t xo√° s·∫£n ph·∫©m m·∫´u
  document.getElementById('btnRemoveSamples')?.addEventListener('click', ()=>{
    const count = removeSampleCards();
    store.set('hideSampleProducts', true);
    alert(`ƒê√£ xo√° ${count} s·∫£n ph·∫©m m·∫´u (n·∫øu c√≥).`);
  });

  // T·∫°o n√∫t xo√° tr√™n t·ª´ng card khi b·∫≠t delete mode
  function ensureDeleteBadges(){
    grid.querySelectorAll('.card').forEach(card=>{
      if(card.querySelector('.delete-badge')) return;
      const badge = document.createElement('span');
      badge.className = 'delete-badge';
      badge.textContent = 'Xo√°';
      badge.addEventListener('click', ()=>{
        card.remove();
      });
      card.appendChild(badge);
    });
  }

  // C·ªë g·∫Øng t√¨m & xo√° c√°c th·∫ª s·∫£n ph·∫©m m·∫´u ph·ªï bi·∫øn
  function removeSampleCards(){
    const selectors = ['.sample', '.is-sample', '[data-sample="1"]'];
    let removed = 0;
    selectors.forEach(sel => {
      grid.querySelectorAll(sel).forEach(el => { el.remove(); removed++; });
    });
    return removed;
  }
</script>

<!-- Script ch√≠nh (n·∫øu b·∫°n c√≥ s·∫µn logic upload s·∫£n ph·∫©m) -->
<script>
/* =========================
   C·∫§U H√åNH ENDPOINT
========================= */
const API_PRODUCTS = '/api/products';
const API_UPLOAD   = '/api/upload-image'; // POST base64 -> { url }
const API_ADD      = '/api/add-product';  // POST product -> { ok: true }
const API_DELETE   = '/api/delete-product'; // POST { id } -> { ok: true }

/* =========================
   TI·ªÜN √çCH
========================= */
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const fmt = (n) => (+n || 0).toLocaleString('vi-VN') + ' ƒë';
const slug = (s) => (s||'').toString().toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

function fileToDataUrl(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

// hi·ªÉn th·ªã toast ƒë∆°n gi·∫£n
function toast(msg){ alert(msg); }

/* =========================
   HERO (local & upload)
========================= */
const hero = {
  title: $('#heroTitle'),
  sub:   $('#heroSub'),
  image: $('#heroImage'),

  inputTitle: $('#heroTitleInput'),
  inputSub:   $('#heroSubInput'),
  inputUrl:   $('#heroUrlInput'),
  inputFile:  $('#heroFile'),
  btnUpload:  $('#btnHeroUpload'),
  btnApply:   $('#btnHeroApply'),
  btnSaveLocal: $('#btnHeroSaveLocal'),

  set(title, sub, url){
    if(title) this.title.textContent = title;
    if(sub)   this.sub.textContent   = sub;
    if(url)   this.image.style.backgroundImage = `url("${url}")`;
    else     this.image.style.backgroundImage = '';
  },

  getLocal(){
    try { return JSON.parse(localStorage.getItem('hero-config')||'{}'); }
    catch { return {}; }
  },
  saveLocal(obj){
    localStorage.setItem('hero-config', JSON.stringify(obj||{}));
    toast('ƒê√£ l∆∞u hero v√†o tr√¨nh duy·ªát.');
  },
  applyFromLocal(){
    const cfg = this.getLocal();
    this.set(cfg.title, cfg.sub, cfg.url);
    if(cfg.title) this.inputTitle.value = cfg.title;
    if(cfg.sub)   this.inputSub.value   = cfg.sub;
    if(cfg.url)   this.inputUrl.value   = cfg.url;
  }
};

// √Åp d·ª•ng hero t·ª´ local khi m·ªü trang
hero.applyFromLocal();

// Upload ·∫£nh hero -> storage
hero.btnUpload?.addEventListener('click', async ()=>{
  try {
    const adm = $('#adminToken')?.value?.trim() || '';
    const f = hero.inputFile?.files?.[0];
    const folder = 'hero';

    if(!f) return toast('Ch·ªçn ·∫£nh tr∆∞·ªõc!');
    const dataUrl = await fileToDataUrl(f);

    const r = await fetch(API_UPLOAD, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'x-admin-token': adm },
      body: JSON.stringify({ dataUrl, filename: f.name, folder })
    });
    const j = await r.json();
    if(!r.ok) throw new Error(j.error||'Upload l·ªói');
    hero.inputUrl.value = j.url;
    toast('Upload ·∫£nh b√¨a th√†nh c√¥ng!');
  } catch(e){ toast(`Upload l·ªói: ${e.message}`); }
});

// √Åp d·ª•ng hero ra trang
hero.btnApply?.addEventListener('click', ()=>{
  hero.set(hero.inputTitle?.value, hero.inputSub?.value, hero.inputUrl?.value);
});

// L∆∞u hero v√†o localStorage
hero.btnSaveLocal?.addEventListener('click', ()=>{
  hero.saveLocal({
    title: hero.inputTitle?.value,
    sub:   hero.inputSub?.value,
    url:   hero.inputUrl?.value
  });
});

/* =========================
   N·∫†P S·∫¢N PH·∫®M V√Ä HI·ªÇN TH·ªä
========================= */
async function loadProducts(){
  try {
    const r = await fetch(API_PRODUCTS);
    const j = await r.json();

    $('#loadNote').textContent = '';
    renderProducts(j?.data||[]);
  } catch (e){
    $('#loadNote').textContent = 'Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ server, ƒëang hi·ªÉn th·ªã d·ªØ li·ªáu g·∫ßn nh·∫•t.';
  }
}

function renderProducts(items){
  const wrap = $('#productGrid');
  wrap.innerHTML = '';
  if(!items.length){
    wrap.innerHTML = '<p class="muted">Ch∆∞a c√≥ s·∫£n ph·∫©m.</p>';
    return;
  }

  for(const it of items){
    const pics = it.image_urls?.length ? it.image_urls : (it.image_url ? [it.image_url] : []);
    const cover = pics[0] || '';
    const pid = it.id ?? it._id ?? null; // c·ªë g·∫Øng b·∫Øt id s·∫£n ph·∫©m (t√πy backend)

    const card = document.createElement('div');
    card.className = 'card';
    if(pid) card.dataset.id = pid;
    card.innerHTML = `
      <div class="cover" style="background-image:url('${cover}')"></div>
      <div class="body">
        <strong>${it.name||''}</strong>
        <div class="muted">${it.desc||''}</div>
        <div style="display:flex; align-items:center; gap:.5rem; margin-top:.25rem">
          ${it.list_price ? `<span class="list-price">${fmt(it.list_price)}</span>` : ''}
          <span class="price">${fmt(it.price || it.list_price)}</span>
        </div>
        <div style="display:flex; gap:8px; margin-top:.5rem; flex-wrap:wrap">
          <button class="btn secondary">Xem chi ti·∫øt</button>
          <button class="btn">ƒê·∫∑t nhanh</button>
          ${pid ? `<button class="btn danger" data-del="${pid}" title="Xo√° s·∫£n ph·∫©m n√†y">Xo√°</button>` : ''}
        </div>
      </div>
    `;
    wrap.appendChild(card);
  }
}

// L·∫Øng nghe n√∫t xo√° theo ID (event delegation)
$('#productGrid')?.addEventListener('click', async (e)=>{
  const btn = e.target.closest('[data-del]');
  if(!btn) return;

  const id = btn.getAttribute('data-del');
  if(!id) return;
  if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s·∫£n ph·∫©m n√†y?')) return;

  try{
    const adm = $('#adminToken')?.value?.trim() || '';
    const r = await fetch(API_DELETE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-admin-token': adm },
      body: JSON.stringify({ id })
    });
    const j = await r.json();
    if(!r.ok) throw new Error(j.error || 'Xo√° s·∫£n ph·∫©m l·ªói');

    // Xo√° kh·ªèi DOM ngay
    btn.closest('.card')?.remove();
    toast('ƒê√£ xo√° s·∫£n ph·∫©m.');
    // (tu·ª≥ ch·ªçn) n·∫°p l·∫°i danh s√°ch ƒë·ªÉ ƒë·ªìng b·ªô
    // await loadProducts();
  }catch(e){
    toast(`L·ªói xo√°: ${e.message}`);
  }
});

/* =========================
   TH√äM S·∫¢N PH·∫®M (UPLOAD + CREATE)
========================= */
const uploaded = []; // c√°c URL ƒë√£ upload cho s·∫£n ph·∫©m

$('#btnUploadProdImgs')?.addEventListener('click', async ()=>{
  try{
    const adm = $('#adminToken')?.value?.trim() || '';
    const files = $('#pImages')?.files;
    if(!files?.length) return toast('Ch·ªçn ·∫£nh tr∆∞·ªõc!');

    const folder = `products/${slug($('#pName')?.value||'san-pham')}`;
    for(const f of files){
      const dataUrl = await fileToDataUrl(f);
      const r = await fetch(API_UPLOAD, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'x-admin-token': adm },
        body: JSON.stringify({ dataUrl, filename: f.name, folder })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j.error||'Upload ·∫£nh l·ªói');

      uploaded.push(j.url);
      addChip(j.url);
    }

    toast('ƒê√£ upload ·∫£nh s·∫£n ph·∫©m xong.');
  }catch(e){ toast(`Upload ·∫£nh l·ªói: ${e.message}`); }
});

$('#btnClearUploaded')?.addEventListener('click', ()=>{
  uploaded.length = 0;
  $('#uploadedChips').innerHTML = '';
});

function addChip(url){
  const c = document.createElement('span');
  c.className = 'chip';
  c.textContent = url.split('/').pop();
  $('#uploadedChips').appendChild(c);
}

$('#btnCreateProduct')?.addEventListener('click', async ()=>{
  try{
    const adm = $('#adminToken')?.value?.trim() || '';
    const name = $('#pName')?.value?.trim();
    const list_price = +($('#pListPrice')?.value) || 0;
    const price = +($('#pPrice')?.value) || 0;
    const desc = $('#pDesc')?.value?.trim();

    if(!name) return toast('Nh·∫≠p t√™n s·∫£n ph·∫©m!');
    if(!uploaded.length) return toast('B·∫°n ch∆∞a upload ·∫£nh s·∫£n ph·∫©m!');

    const body = { name, list_price, price, desc, image_urls: uploaded, active: true };

    const r = await fetch(API_ADD, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'x-admin-token': adm },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!r.ok) throw new Error(j.error||'T·∫°o s·∫£n ph·∫©m l·ªói');

    toast('ƒê√£ t·∫°o s·∫£n ph·∫©m th√†nh c√¥ng!');
    // reset form nh·∫π
    $('#pName').value = '';
    $('#pListPrice').value = '';
    $('#pPrice').value = '';
    $('#pDesc').value = '';
    $('#pImages').value = '';
    $('#uploadedChips').innerHTML = '';
    uploaded.length = 0;

    // n·∫°p l·∫°i danh s√°ch
    loadProducts();
  }catch(e){ toast(`L·ªói: ${e.message}`); }
});

/* =========================
   KH·ªûI T·∫†O
========================= */
loadProducts();

</script>
</body>
</html>
